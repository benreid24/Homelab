- name: Ensure service docker directories exist
  ansible.builtin.file:
    path: "{{ services_config_path }}/{{ item }}"
    state: directory
    owner: homelab
    group: homelab
    mode: '0755'
  loop: "{{ enabled_services | default([]) }}"

- name: Ensure service data directories exist
  ansible.builtin.file:
    path: "{{ services_data_path }}/{{ item }}"
    state: directory
    owner: homelab
    group: homelab
    mode: '0755'
  loop: "{{ enabled_services | default([]) }}"

- name: Copy service files
  ansible.builtin.synchronize:
    src: "services/{{ item }}/"
    dest: "{{ services_config_path }}/{{ item }}/"
    recursive: yes
    rsync_opts:
      - "--chmod=Du=rwx,Dg=rx,Do=rx,Fu=rw,Fg=r,Fo=r"
  loop: "{{ enabled_services | default([]) }}"

- name: Configure service-specific settings
  include_tasks: "{{ item }}.yml"
  loop: "{{ enabled_services | default([]) }}"
  when: item in enabled_services

- name: Trigger service restarts for changed configs
  debug:
    msg: "Services to restart: {{ services_to_restart | default([]) }}"
  changed_when: services_to_restart is defined and services_to_restart | length > 0
  notify: restart service

- name: Ensure Docker Compose services are started
  ansible.builtin.shell: >
    docker compose -f {{ services_config_path }}/{{ item }}/docker-compose.yml up -d --no-recreate
  loop: "{{ enabled_services | default([]) }}"
  become: true
