- name: Ensure service docker directories exist
  ansible.builtin.file:
    path: "{{ services_config_path }}/{{ item }}"
    state: directory
    owner: "{{ service_user }}"
    group: "{{ service_group }}"
    mode: '0755'
  loop: "{{ enabled_services | default([]) }}"

- name: Ensure service data directories exist
  ansible.builtin.file:
    path: "{{ services_data_path }}/{{ item }}"
    state: directory
    owner: "{{ service_user }}"
    group: "{{ service_group }}"
    mode: '0755'
  loop: "{{ enabled_services | default([]) }}"

- name: Check docker-compose files and Dockerfiles for changes
  stat:
    path: "{{ services_config_path }}/{{ item[0] }}/{{ item[1] }}"
    checksum_algorithm: sha1
  loop: "{{ enabled_services | product(['docker-compose.yml', 'Dockerfile']) | list }}"
  register: dest_files

- name: Get source file checksums
  stat:
    path: "{{ role_path }}/files/services/{{ item[0] }}/{{ item[1] }}"
    checksum_algorithm: sha1
  loop: "{{ enabled_services | product(['docker-compose.yml', 'Dockerfile']) | list }}"
  register: src_files
  connection: local
  become: false

- name: Mark services for restart if compose files or Dockerfiles changed
  set_fact:
    services_to_restart: "{{ services_to_restart | default([]) | union([item.0.item[0]]) }}"
  loop: "{{ src_files.results | zip(dest_files.results) | list }}"
  when: 
    - item.0.stat.exists
    - item.1.stat.exists
    - item.0.stat.checksum != item.1.stat.checksum

- name: Copy service files
  ansible.builtin.synchronize:
    src: "services/{{ item }}/"
    dest: "{{ services_config_path }}/{{ item }}/"
    recursive: yes
    rsync_opts:
      - "--chmod=Du=rwx,Dg=rx,Do=rx,Fu=rw,Fg=r,Fo=r"
  loop: "{{ enabled_services | default([]) }}"

- name: Run service-specific tasks
  include_tasks: "{{ item }}.yml"
  loop: "{{ enabled_services | default([]) }}"
  when: item in enabled_services

- name: Trigger service restarts for changed configs
  debug:
    msg: "Services to restart: {{ services_to_restart | default([]) }}"
  changed_when: services_to_restart is defined and services_to_restart | length > 0
  notify: restart service

- name: Ensure Docker services are started
  ansible.builtin.shell: >
    cd {{ services_config_path }}/{{ item }} && docker compose up -d --no-recreate
  loop: "{{ enabled_services | default([]) }}"
  become: true 
  become_user: "{{ service_user }}"
