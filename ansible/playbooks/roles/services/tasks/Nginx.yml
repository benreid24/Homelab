- name: Write Nginx .env file
  copy:
    dest: "{{ services_config_path }}/Nginx/.env"
    mode: '0600'
    content: |
      CONF_PATH={{ nginx.conf_path }}
      HOSTNAME={{ external_hostname }}
      CERTS_PATH={{ nginx.certs_path }}
      STATIC_PATH={{ nginx.static_path }}
      LETSENCRYPT_LIB_PATH={{ nginx.letsencrypt_lib_path }}
      CLOUDFLARE_CREDENTIALS_PATH={{ nginx.cloudflare_credentials_path }}
      CLOUDFLARE_API_TOKEN={{ cloudflare_dns_api_token }}
      CLOUDFLARE_ZONE_ID={{ cloudflare_zone_id }}
  register: nginx_env_config

- name: Write Cloudflare credentials file
  copy:
    dest: "{{ nginx.cloudflare_credentials_path }}"
    mode: '0600'
    owner: homelab
    group: homelab
    content: |
      dns_cloudflare_api_token = {{ cloudflare_dns_api_token }}

- name: Ensure Nginx sites-enabled directory exists
  ansible.builtin.file:
    path: "{{ nginx.conf_path }}/sites-enabled"
    state: directory
    owner: homelab
    group: homelab
    mode: '0755'

- name: Template all nginx site configs
  ansible.builtin.template:
    src: "{{ config_file }}"
    dest: "{{ nginx.conf_path }}/sites-enabled/{{ config_file | basename | regex_replace('\\.j2$', '') }}"
    owner: homelab
    group: homelab
    mode: '0644'
  with_fileglob:
    - "templates/Nginx/sites-enabled/*.conf.j2"
  loop_control:
    loop_var: config_file
  register: nginx_site_configs

- name: Template all nginx common configs
  ansible.builtin.template:
    src: "{{ config_file }}"
    dest: "{{ nginx.conf_path }}/{{ config_file | basename | regex_replace('\\.j2$', '') }}"
    owner: homelab
    group: homelab
    mode: '0644'
  with_fileglob:
    - "templates/Nginx/common/*.conf.j2"
  loop_control:
    loop_var: config_file
  register: nginx_common_configs

- name: Mark Nginx for restart
  set_fact:
    services_to_restart: "{{ services_to_restart | default([]) | union(['Nginx']) }}"
  when: >
    nginx_env_config.changed or
    nginx_site_configs.changed or
    nginx_common_configs.changed

- name: Ensure homelab docker network exists
  ansible.builtin.shell: >
    docker network inspect homelab >/dev/null 2>&1 || docker network create homelab --subnet {{ docker_network_subnet }}
  become: true

- name: Start certbot container to obtain certificates
  ansible.builtin.shell: >
    docker compose -f {{ services_config_path }}/Nginx/docker-compose.yml up -d certbot
  become: true

- name: Check if Let's Encrypt certificate exists
  stat:
    path: "{{ nginx.certs_path }}/live/{{ external_hostname }}/fullchain.pem"
  register: letsencrypt_cert

- name: Wait for certbot container to be ready
  ansible.builtin.pause:
    seconds: 5
  when: not letsencrypt_cert.stat.exists

- name: Obtain Let's Encrypt certificate if not present
  ansible.builtin.shell: >
    docker exec certbot certbot certonly
    --dns-cloudflare
    --dns-cloudflare-credentials /etc/cloudflare.ini
    --dns-cloudflare-propagation-seconds 60
    -d {{ external_hostname }}
    -d "*.{{ external_hostname }}"
    --email "{{ admin_email }}"
    --agree-tos
    --non-interactive
    {{ '--staging' if certbot_env == 'staging' else '' }}
  become: true
  when: not letsencrypt_cert.stat.exists
  register: certbot_result
  failed_when: certbot_result.rc != 0

- name: Set up certbot renewal cron job
  ansible.builtin.cron:
    name: "Renew Let's Encrypt certificates"
    minute: "13"
    hour: "3"
    job: "docker exec certbot certbot renew --quiet && docker exec nginx nginx -s reload"
    user: root
